<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 7-1 Exercises 副詞・副詞句</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
        }
        .control-button:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        .highlight {
            color: #16A34A; /* green-600 */
            font-weight: bold;
        }
        .placeholder {
            color: #3B82F6; /* blue-500 */
            font-weight: bold;
        }
        .incorrect {
            color: #E53E3E; /* red-600 */
            text-decoration: line-through;
        }
        .explanation-panel, .recognition-panel {
            transition: all 0.3s ease-in-out;
        }
        .recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Lesson 7-1 Exercises</h1>
            <p class="text-gray-600 mt-2">副詞・副詞句 練習問題</p>
        </header>

        <main class="space-y-6" id="main-content">
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">1. 空所補充</h2>
                <div id="sentences-1" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-green-500 pl-4 mb-4">2. 語句補充</h2>
                <div id="sentences-2" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-yellow-500 pl-4 mb-4">3. 文法上の誤り訂正</h2>
                <div id="sentences-3" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-purple-500 pl-4 mb-4">4. 語句整序</h2>
                <div id="sentences-4" class="space-y-4"></div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-red-500 pl-4 mb-4">5. 和文英訳</h2>
                <div id="sentences-5" class="space-y-4"></div>
            </section>
        </main>
    </div>

    <script>
        const sentences = [
            // 1. 空所補充 (Category 1)
            { id: 1, category: '1', en: "Clearly, the decision was right.", jp: "明らかに，その判断は正しかった。", explanation: "「明らかに」は文修飾の副詞clearlyあるいはobviously, evidentlyを使う。", answer: "Clearly" },
            { id: 2, category: '1', en: "Feeling cold, she turned the heater on.", jp: "寒かったので，彼女は暖房を入れた。", explanation: "現在分詞で始まる理由を表す分詞構文。接続詞を使うと，Because she felt coldとなる。", answer: "Feeling cold" },
            { id: 3, category: '1', en: "Unfortunately, none of what she said was taken seriously by her classmates.", jp: "残念ながら，クラスメートたちは彼女の言うことを何1つ真剣に受け取らなかった。", explanation: "「残念ながら」は文修飾の副詞unfortunatelyあるいはregrettablyで表す。「～を真剣に受け取る」take ～ seriouslyを受動態にした文。", answer: ["Unfortunately", "seriously"] },
            { id: 4, category: '1', en: "This chair is comfortable to sit on.", jp: "このイスは座り心地が良い。", explanation: "comfortableを修飾する副詞的用法の不定詞 (形容詞の限定)。 It is comfortable to sit on [in] this chair.と同意。前置詞のon/inを省略しないこと。難易・安全／危険・快／不快を表す形容詞で使われる用法。", answer: "to sit on" },
            { id: 5, category: '1', en: "In order to catch the last bus, I have to finish all my work by 10:40.", jp: "最終バスに間に合うよう，すべての仕事を10時40分までに仕上げなければいけない。", explanation: "文頭で「～するために」という目的を表すには，in order to do を使う。｢バスに間に合う｣はcatch the busまたはmake the bus。", answer: "In order to catch" },
            
            // 2. 語句補充 (Category 2)
            { id: 6, category: '2', en: "A friend of mine who lives in Seattle is coming to see me for the first time in five years.", jp: "シアトルに住んでいる友人が5年ぶりに私に会いに来る。", explanation: "「～年ぶりに…」は，〈for the first time in ～ years〉で表す。", answer: "for the first time in five" },
            { id: 7, category: '2', en: "When you travel abroad, be sure to take an electronic dictionary with you.", jp: "海外旅行をする時には，必ず電子辞書を持って行きなさい。", explanation: "abroadは「外国 へ[で]」， overseas は「海外に[で]」は 副詞なのでtoを付けるのは誤り。travelの代わりにgoを使って，go abroadあるいはgo overseasとしてもよい。", answer: "you travel abroad" },
            { id: 8, category: '2', en: "Learning English has become popular in Japan, regardless of age or gender.", jp: "英語を学ぶことは，年齢や性別とは関係なく日本で人気となった。", explanation: "「～とは関係なく，～にかかわらず」は〈regardless of＋名詞〉で表す。「～になった」はここでは現在完了の完了の用法でhave become ～を使う。", answer: ["has become", "regardless of age or gender"] },
            { id: 9, category: '2', en: "Written in plain English, the book is suitable for beginners.", jp: "わかりやすい英語で書かれているので，その本は初心者向きである。", explanation: "過去分詞で始まる理由を表す分詞構文。接続詞を使うと，Because it is written in plain [easy / simple] English,となる。", answer: "Written in plain English" },
            { id: 10, category: '2', en: "I was very surprised to see Michiko at the party.", jp: "そのパーティーで美智子に会ってとても驚いた。", explanation: "「～して」という感情の原因は不定詞to do で表す。「会う」はこの場合，meetよりもseeを使うほうがよい。meetは初めて出会う場合に使うことが多い。美智子とはすでに会ったことがあり，知り合いである可能性が高いのでseeを使う。", answer: "very surprised to see" },

            // 3. 文法上の誤り訂正 (Category 3)
            { id: 11, category: '3', 
              en_incorrect: "All things considering, the chorus club decided to postpone its winter concert.", 
              en_correct: "All things <span class='highlight'>considered</span>, the chorus club decided to postpone its winter concert.",
              correct_speech: "All things considered, the chorus club decided to postpone its winter concert.",
              jp: "あらゆる点を考慮に入れて，コーラス部は冬のコンサートを延期することを決めた。", 
              explanation: "all things considered「すべてのことを考慮すると」は慣用的な分詞構文。「すべてのことが考慮される」なので，過去分詞を使う。" 
            },
            { id: 12, category: '3', 
              en_incorrect: "He left his hometown approximate six months ago.", 
              en_correct: "He left his hometown <span class='highlight'>approximately</span> six months ago.",
              correct_speech: "He left his hometown approximately six months ago.",
              jp: "彼は約6か月前に故郷を出た。", 
              explanation: "「約，およそ」は数詞を修飾する副詞なのでapproximatelyとする。" 
            },
            { id: 13, category: '3', 
              en_incorrect: "Judged from his looks, he must be well over sixty.", 
              en_correct: "<span class='highlight'>Judging</span> from his looks, he must be well over sixty.",
              correct_speech: "Judging from his looks, he must be well over sixty.",
              jp: "外見から判断すると，彼は60歳をはるかに超えているに違いない。", 
              explanation: "judging from ～「～から判断すると」は慣用的な分詞構文。" 
            },
            { id: 14, category: '3', 
              en_incorrect: "Honest speaking, I don’t think that that is a good idea.", 
              en_correct: "<span class='highlight'>Honestly</span> speaking, I don’t think that that is a good idea.",
              correct_speech: "Honestly speaking, I don’t think that that is a good idea.",
              jp: "正直に言うと，それは良い考えではないと思う。", 
              explanation: "副詞なのでhonestlyとする。honestly speaking「正直に言うと」も慣用表現。" 
            },
            { id: 15, category: '3', 
              en_incorrect: "Too much exercise can positively affect your body, and therefore it is important to exercise moderately.", 
              en_correct: "Too much exercise can <span class='highlight'>negatively</span> affect your body, and therefore it is important to exercise moderately.",
              correct_speech: "Too much exercise can negatively affect your body, and therefore it is important to exercise moderately.",
              jp: "過度の運動は体に悪影響を及ぼし得る。それゆえ適度に運動することが大切だ。", 
              explanation: "文脈から適切な副詞に変える。positively「良い方向に」⇔ negatively「悪い方向に」。" 
            },

            // 4. 語句整序 (Category 4)
            { id: 16, category: '4', en: "Mr. Brown sat through the whole meeting with his eyes closed.", jp: "ブラウンさんは会議の間中，ずっと目を閉じたまま座っていた。", scrambled: "( closed / his eyes / meeting / the whole / with )", answer: "the whole meeting with his eyes closed", explanation: "〈with＋O＋分詞〉で「～が…している状態で，…したまま」という付帯状況を表す。withの後にくる名詞や代名詞 ( ここではhis eyes ) は，分詞 ( ここではclosed )の 意味上の主語の働きをしている。" },
            { id: 17, category: '4', en: "We had to call off the game because of a huge blackout.", jp: "大規模な停電のため，私たちは試合を中止しなければならなかった。", scrambled: "( because / call / game / of / off / the )", answer: "call off the game because of", explanation: "「～のため」because of ～を使う。call off ～ / call ～off「～を中止する」。" },
            { id: 18, category: '4', en: "I went to class in spite of feeling a little sick.", jp: "少し気分がすぐれなかったにもかかわらず，私は授業に出た。", scrambled: "( a / feeling / in / little / of / spite )", answer: "in spite of feeling a little", explanation: "「～にもかかわらず」in spite of ～を使う。ofの後に 動名詞がくる 。" },
            { id: 19, category: '4', en: "I woke up to find myself in hospital.", jp: "目が覚めると，私は自分が医院にいることに気が付いた。", scrambled: "( find / in hospital / myself / to )", answer: "to find myself in hospital", explanation: "〈wake up [awake] to find ～〉は結果を表す不定詞の慣用表現。「目を覚ますと～と気付く」を意味する。" },
            
            // 5. 和文英訳 (Category 5)
            { id: 20, category: '5', en: "The doctor will get home in thirty minutes.", jp: "お医者さんは30分で帰宅するでしょう。", answer: "The doctor will get home in thirty minutes.", explanation: "〈in＋数詞＋時の表現〉で「 (何かをするのに) ～時間がかかる」を意味する。" },
            { id: 21, category: '5', en: "He was foolish to do such a dangerous thing.", jp: "そんな危ないことをするなんて，彼は愚かだった。", answer: "He was foolish to do such a dangerous thing.", explanation: "判断の根拠を表す不定詞の副詞的用法を使う。形式主語構文でIt was foolish of him to do such a dangerous thing.と同意。「そんな危ないことをする」はtake such a riskも可。" },
            { id: 22, category: '5', en: "Thanks to John’s assistance, I was able to meet the deadline.", jp: "ジョンの支援のおかげで，私は締め切りに間に合うことができた。", answer: "Thanks to John’s assistance, I was able to meet the deadline.", explanation: "〈thanks to＋名詞〉で「～のおかげで，～のせいで」を表す。〈due to＋名詞〉「～のために」を使ってもよい。「 (特定の事柄が一回)で きた」という意味のときはcouldではなくwas able toを使う。" },
            { id: 23, category: '5', en: "Nowadays, I rarely watch TV and I spend a lot of time on the internet instead.", jp: "最近私はテレビをほとんど見ないが，代わりにインターネットを見て多くの時間を過ごす。", answer: "Nowadays, I rarely watch TV and I spend a lot of time on the internet instead.", explanation: "nowadays「最近」は現在形・現在進行形と共に使い，文頭や文末に置く。rarely [seldom, hardly ever]「ほとんど～ない」は一般動詞の前に置く。lately, recently「最近」は現在完了形と共に使うことが多い。「代わりに」は副詞insteadで表す。" },
            { id: 24, category: '5', en: "They say we had heavy snowfall like this for the first time in 15 years.", jp: "こんな大雪になったのは15年ぶりらしい。", answer: "They say we had heavy snowfall like this for the first time in 15 years.", explanation: "「15年ぶりにこんな大雪になったと言われている」と考え，〈(for) the first time in ～ years〉を使う。They say (that) we haven’t had heavy snowfall like this for 15 years.としてもよい。" }
        ];

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let mediaRecorder;
        let mediaStream;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        } else {
            console.log("Speech Recognition Not Supported");
        }

        function calculateSimilarity(s1, s2) {
            let longer = s1;
            let shorter = s2;
            if (s1.length < s2.length) {
                longer = s2;
                shorter = s1;
            }
            let longerLength = longer.length;
            if (longerLength === 0) {
                return 1.0;
            }
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }

        function editDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();

            const costs = new Array();
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) {
                        costs[j] = j;
                    } else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1))
                                newValue = Math.min(Math.min(newValue, lastValue),
                                    costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0)
                    costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }


        function handleRecording(sentence, recordButton, resultPanel) {
            if (!recognition) {
                resultPanel.innerHTML = `<p class="text-red-500">お使いのブラウザは音声認識に対応していません。</p>`;
                return;
            }

            if (recordButton.classList.contains('recording')) {
                recognition.stop(); 
                return;
            }
            
            resultPanel.innerHTML = ''; 

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaStream = stream; 
                    mediaRecorder = new MediaRecorder(stream);
                    let audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        if (audioChunks.length === 0) return;

                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        if (resultPanel.innerHTML.trim() !== '' && !resultPanel.querySelector('.playback-div')) {
                            const playbackDiv = document.createElement('div');
                            playbackDiv.className = 'playback-div flex items-center space-x-2 mt-3 pt-3 border-t border-gray-200';
                            playbackDiv.innerHTML = `
                                <button class="control-button p-2 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 focus:outline-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <p class="text-sm text-gray-600">自分の音声を確認する</p>
                            `;
                            const audioPlayer = new Audio(audioUrl);
                            playbackDiv.querySelector('button').onclick = () => {
                                audioPlayer.play();
                            };
                            
                            resultPanel.appendChild(playbackDiv);
                        }
                        audioChunks = [];
                    };

                    recognition.start();

                    recognition.onstart = () => {
                        recordButton.classList.add('recording');
                        recordButton.classList.remove('bg-green-500');
                        recordButton.classList.add('bg-red-500');
                        recordButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h.01M15 10h.01M9 14h6" /></svg>`; // Stop icon
                        resultPanel.innerHTML = `<p class="text-gray-500">録音中...</p>`;
                        mediaRecorder.start();
                    };

                    recognition.onend = () => {
                        recordButton.classList.remove('recording');
                        recordButton.classList.remove('bg-red-500');
                        recordButton.classList.add('bg-green-500');
                        recordButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v3a3 3 0 01-3 3z" /></svg>`; // Mic icon
                        
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                        if (mediaStream) {
                            mediaStream.getTracks().forEach(track => track.stop());
                        }
                    };

                    recognition.onresult = (event) => {
                        if (!event.results || !event.results[0] || !event.results[0][0] || !event.results[0][0].transcript) {
                            console.warn("Speech recognition result was empty or invalid.");
                            resultPanel.innerHTML = `<p class="text-yellow-600">音声を認識できませんでした。もう一度お試しください。</p>`;
                            return;
                        }

                        const transcript = event.results[0][0].transcript;
                        const cleanOriginal = sentence;
                        const cleanTranscript = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s\s+/g, ' ').trim().toLowerCase();
                        
                        const similarity = calculateSimilarity(cleanOriginal, cleanTranscript);
                        const score = Math.round(similarity * 100);

                        let feedback = '';
                        let colorClass = '';
                        if (score >= 85) {
                            feedback = '素晴らしい！';
                            colorClass = 'text-green-600';
                        } else if (score >= 65) {
                            feedback = '惜しい！';
                            colorClass = 'text-yellow-600';
                        } else {
                            feedback = 'もう一度！';
                            colorClass = 'text-red-600';
                        }
                        
                        const resultDiv = document.createElement('div');
                        resultDiv.innerHTML = `
                            <p class="text-gray-800">あなたの発音: 「${transcript}」</p>
                            <div class="flex items-center mt-2">
                                <p class="font-bold ${colorClass}">${feedback}</p>
                                <p class="ml-4 text-sm text-gray-600">スコア: ${score}点</p>
                            </div>
                        `;
                        resultPanel.innerHTML = '';
                        resultPanel.appendChild(resultDiv);
                    };

                    recognition.onerror = (event) => {
                         resultPanel.innerHTML = `<p class="text-red-500">エラーが発生しました: ${event.error}</p>`;
                         if (mediaRecorder && mediaRecorder.state === 'recording') {
                             mediaRecorder.stop();
                         }
                         if (mediaStream) {
                             mediaStream.getTracks().forEach(track => track.stop());
                         }
                    };
                })
                .catch(err => {
                    console.error("getUserMedia error:", err);
                    resultPanel.innerHTML = `<p class="text-red-500">マイクへのアクセス許可が必要です。ブラウザの設定を確認し、ページを再読み込みしてください。</p>`;
                });
        }


        function createSentenceCard(sentence) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-md';
            
            const contentAndControls = document.createElement('div');
            contentAndControls.className = 'flex items-start space-x-4';

            const numberDiv = document.createElement('div');
            numberDiv.className = 'flex-shrink-0 bg-gray-200 text-gray-700 font-bold rounded-full h-8 w-8 flex items-center justify-center text-sm';
            numberDiv.textContent = String(sentence.id);

            const textContentDiv = document.createElement('div');
            textContentDiv.className = 'flex-grow';

            const enP = document.createElement('p');
            enP.className = 'text-lg text-gray-800 font-medium';

            const jpP = document.createElement('p');
            jpP.className = 'text-gray-600 mt-1';
            jpP.textContent = sentence.jp;

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'flex flex-col items-center space-y-2 ml-2';

            const audioButton = document.createElement('button');
            audioButton.className = 'control-button p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 focus:outline-none';
            audioButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;

            const recordButton = document.createElement('button');
            recordButton.className = 'control-button p-2 rounded-full bg-green-500 text-white hover:bg-green-600 focus:outline-none';
            recordButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v3a3 3 0 01-3 3z" /></svg>`;

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex items-center space-x-2 mt-2';

            const toggleAnswerButton = document.createElement('button');
            toggleAnswerButton.className = 'control-button text-xs px-2 py-1 bg-yellow-400 text-yellow-800 rounded-md hover:bg-yellow-500';
            toggleAnswerButton.textContent = '解答表示';

            const toggleButton = document.createElement('button');
            toggleButton.className = 'control-button text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300';
            toggleButton.textContent = '解説';

            const correctSpeechText = sentence.correct_speech || sentence.en.replace(/<[^>]*>?/gm, '');

            audioButton.onclick = () => {
                if (speechSynthesis.speaking) speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(correctSpeechText);
                utterance.lang = 'en-US';
                speechSynthesis.speak(utterance);
            };

            const recognitionPanel = document.createElement('div');
            recognitionPanel.className = 'recognition-panel mt-3';
            
            recordButton.onclick = () => handleRecording(correctSpeechText, recordButton, recognitionPanel);

            let isAnswerShown = false; 

            if (sentence.category === '5') {
                enP.innerHTML = `<span class="highlight">${sentence.en}</span>`;
                enP.classList.add('hidden');
                toggleAnswerButton.onclick = () => {
                    isAnswerShown = !isAnswerShown;
                    enP.classList.toggle('hidden');
                    toggleAnswerButton.textContent = isAnswerShown ? '解答非表示' : '解答表示';
                };
            } else if (sentence.category === '4') {
                const scrambledHTML = sentence.en.replace(sentence.answer, `<span class='placeholder'>${sentence.scrambled}</span>`);
                const correctHTML = sentence.en.replace(sentence.answer, `<span class='highlight'>${sentence.answer}</span>`);
                enP.innerHTML = scrambledHTML;
                toggleAnswerButton.onclick = () => {
                    isAnswerShown = !isAnswerShown;
                    enP.innerHTML = isAnswerShown ? correctHTML : scrambledHTML;
                    toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '解答表示';
                };
            } else if (sentence.category === '3') {
                const plainIncorrectHTML = sentence.en_incorrect.replace(/<[^>]*>?/gm, '');
                enP.innerHTML = plainIncorrectHTML;
                toggleAnswerButton.onclick = () => {
                    isAnswerShown = !isAnswerShown;
                    enP.innerHTML = isAnswerShown ? sentence.en_correct : plainIncorrectHTML;
                    toggleAnswerButton.textContent = isAnswerShown ? '問題文表示' : '解答表示';
                };
            } else { // Categories '1' & '2'
                let answers = Array.isArray(sentence.answer) ? sentence.answer : [sentence.answer];
                let hiddenHTML = sentence.en;
                let correctHTML = sentence.en;
                
                answers.forEach(ans => {
                    const placeholder = ` <span class='placeholder'>( ${'_____'.repeat(ans.split(' ').length)} )</span> `;
                    hiddenHTML = hiddenHTML.replace(ans, placeholder);
                    correctHTML = correctHTML.replace(ans, `<span class='highlight'>${ans}</span>`);
                });

                enP.innerHTML = hiddenHTML;
                toggleAnswerButton.onclick = () => {
                    isAnswerShown = !isAnswerShown;
                    enP.innerHTML = isAnswerShown ? correctHTML : hiddenHTML;
                    toggleAnswerButton.textContent = isAnswerShown ? '解答非表示' : '解答表示';
                };
            }
            
            textContentDiv.appendChild(enP);
            textContentDiv.appendChild(jpP);
            
            buttonGroup.appendChild(toggleAnswerButton);
            buttonGroup.appendChild(toggleButton);

            controlsDiv.appendChild(audioButton);
            controlsDiv.appendChild(recordButton);
            controlsDiv.appendChild(buttonGroup);
            
            contentAndControls.appendChild(numberDiv);
            contentAndControls.appendChild(textContentDiv);
            contentAndControls.appendChild(controlsDiv);

            const explanationPanel = document.createElement('div');
            explanationPanel.className = 'explanation-panel hidden mt-3 pt-3 border-t border-gray-200';
            explanationPanel.innerHTML = `<p class="text-gray-700 bg-gray-50 p-3 rounded-md">${sentence.explanation}</p>`;
            toggleButton.onclick = () => {
                explanationPanel.classList.toggle('hidden');
            };


            card.appendChild(contentAndControls);
            card.appendChild(explanationPanel);
            card.appendChild(recognitionPanel);

            return card;
        }

        function renderSentences() {
            if (!SpeechRecognition) {
                const mainContent = document.getElementById('main-content');
                const warning = document.createElement('div');
                warning.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md';
                warning.innerHTML = '<p class="font-bold">音声認識機能が利用できません</p><p>お使いのブラウザは音声認識に対応していないか、マイクへのアクセスが許可されていません。発音練習機能を利用するには、Google Chromeなどの対応ブラウザをご利用ください。</p>';
                mainContent.prepend(warning);
            }
            
            const containers = {
                '1': document.getElementById('sentences-1'),
                '2': document.getElementById('sentences-2'),
                '3': document.getElementById('sentences-3'),
                '4': document.getElementById('sentences-4'),
                '5': document.getElementById('sentences-5'),
            };

            sentences.forEach(sentence => {
                const card = createSentenceCard(sentence);
                if (containers[sentence.category]) {
                    containers[sentence.category].appendChild(card);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', renderSentences);
    </script>
</body>
</html>